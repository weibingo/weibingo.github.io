<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="bitmap与标签存储"><meta name="keywords" content="bitmap,标签"><meta name="author" content="weibingo"><meta name="copyright" content="weibingo"><title>bitmap与标签存储 | WBINGのBLOG</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.8.0"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.8.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"3FYJCLGPHO","apiKey":"d730ef95ff5ff79a19b74363531c066b","indexName":"prod_weibing-blog","hits":{"per_page":10},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#bitmap%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">bitmap简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bitmap%E7%B4%A2%E5%BC%95"><span class="toc-number">2.</span> <span class="toc-text">bitmap索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bitmap%E7%9A%84%E9%80%82%E7%94%A8%E8%8C%83%E5%9B%B4"><span class="toc-number">3.</span> <span class="toc-text">bitmap的适用范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RoaringBitmap"><span class="toc-number">4.</span> <span class="toc-text">RoaringBitmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE"><span class="toc-number">5.</span> <span class="toc-text">标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://hexo-1256892004.cos.ap-beijing.myqcloud.com/page/avatar.jpg"></div><div class="author-info__name text-center">weibingo</div><div class="author-info__description text-center">BIG DATA探索者,经济迷,浅度摄影,爱好历史,对社会意识,人文感兴趣</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/weibingo">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">48</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">43</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">20</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://hexo-1256892004.cos.ap-beijing.myqcloud.com/page/top.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">WBINGのBLOG</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">bitmap与标签存储</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-07-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B/">数据工程</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">1.4k</span><span class="post-meta__separator">|</span><span>Reading time: 5 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>最近在标签存储中，需要根据标签值查询用户id，所以想到在源数据表基础上建立索引。因为标签数据量大，且标签基数相对较少，查询条件往往涉及多标签组合过滤，所以选用了bitmap作为索引。</p>
<h3 id="bitmap简介"><a href="#bitmap简介" class="headerlink" title="bitmap简介"></a>bitmap简介</h3><p>bitmap就是以比特位来存储状态。<br><img src="https://hexo-1256892004.cos.ap-beijing.myqcloud.com/bitmap/bitmap.png" alt="bitmap"></p>
<h3 id="bitmap索引"><a href="#bitmap索引" class="headerlink" title="bitmap索引"></a>bitmap索引</h3><p>例如用户数据表<br><img src="https://hexo-1256892004.cos.ap-beijing.myqcloud.com/bitmap/user_table.png"><br>现在要在用户性别和婚姻状态建立bitmap索引。<br><img src="https://hexo-1256892004.cos.ap-beijing.myqcloud.com/bitmap/user_index.png"><br>通过索引值为1，我们可以看出性别男的用户rowid为1和3，然后在查询源用户表，就可以查出性别男的是张三，王五。婚姻状况同理。<br>下面我们如果要查询：<br>select * from table where Gender&#x3D;’男’ and Marital&#x3D;’未婚’<br>首先我们找到男索引列和未婚索引列，然后对其取并集。<br><img src="https://hexo-1256892004.cos.ap-beijing.myqcloud.com/bitmap/intersection.png"></p>
<span id="more"></span>
<p>因为是bit存储，索引取并集就相当简单，只需要进行位运算&amp;即可。所以整个bitmap索引多条件过滤效率很高。</p>
<h3 id="bitmap的适用范围"><a href="#bitmap的适用范围" class="headerlink" title="bitmap的适用范围"></a>bitmap的适用范围</h3><p>因为bitmap的特性，所以bitmap索引适用于：</p>
<ul>
<li>查询为主，更新较少的数据</li>
<li>基数较少，重复度较多的列</li>
<li>and&#x2F;or可以直接通过位运算快速得到结果。</li>
</ul>
<h3 id="RoaringBitmap"><a href="#RoaringBitmap" class="headerlink" title="RoaringBitmap"></a>RoaringBitmap</h3><p>未压缩的bitmap占有空间大，所以提出了各种的压缩算法。如图：<br><img src="https://hexo-1256892004.cos.ap-beijing.myqcloud.com/bitmap/compress.png"><br>从图中可知，RoaringBitmap是基于Sorted array进行压缩。而其他压缩算法都是基于aligned或者run-length-encoded，核心思想都是把数据规整，然后采用run-length编码。</p>
<p>截取<a target="_blank" rel="noopener" href="https://github.com/RoaringBitmap/RoaringBitmap">RoaringBitmap中的话</a></p>
<blockquote>
<p>Most alternatives to Roaring are part of a larger family of compressed bitmaps that are run-length-encoded bitmaps. They identify long runs of 1s or 0s and they represent them with a marker word. If you have a local mix of 1s and 0, you use an uncompressed word.</p>
</blockquote>
<blockquote>
<p>There are many formats in this family:</p>
</blockquote>
<blockquote>
<ul>
<li>Oracle’s BBC is an obsolete format at this point: though it may provide good compression, it is likely much slower than more recent alternatives due to excessive branching.</li>
</ul>
</blockquote>
<ul>
<li>WAH is a patented variation on BBC that provides better performance.</li>
<li>Concise is a variation on the patented WAH. It some specific instances, it can compress much better than WAH (up to 2x better), but it is generally slower.</li>
<li>EWAH is both free of patent, and it is faster than all the above. On the downside, it does not compress quite as well. It is faster because it allows some form of “skipping” over uncompressed words. So though none of these formats are great at random access, EWAH is better than the alternatives.</li>
</ul>
<blockquote>
<p>There is a big problem with these formats however that can hurt you badly in some cases: there is no random access. If you want to check whether a given value is present in the set, you have to start from the beginning and “uncompress” the whole thing. This means that if you want to intersect a big set with a large set, you still have to uncompress the whole big set in the worst case…</p>
</blockquote>
<p>从中可知，BBC、WAH、Concise、EWAH都是基于run-length-encoded算法，它们很难处理随机读，而且如果想要对两个bitmap取交集，必须解压整个大集合。<br>基于这些问题，RoaringBitmap提出了另一种压缩方法。</p>
<p><img src="https://hexo-1256892004.cos.ap-beijing.myqcloud.com/bitmap/roaringbitmap.png" alt="RoaringBitmap"></p>
<p>图中展示了RoaringBitmap的结构，每个RoaringBitmap中都包含一个RoaringArray，名字叫highLowContainer。<br>highLowContainer存储了RoaringBitmap中的全部数据。</p>
<p><code>RoaringArray highLowContainer;</code><br><img src="https://hexo-1256892004.cos.ap-beijing.myqcloud.com/bitmap/roaringArray.png"><br>具体的讲解可以参照<a target="_blank" rel="noopener" href="https://blog.csdn.net/yizishou/article/details/78342499">RoaringBitmap数据结构及原理</a>这篇文章。<br>RoaringBitmap在设计中结合了Array与Bitmap存储，当数据稀疏时，Array存储会更节省空间（试想[3,10000,200000]这三个数如果用bitmap存储会消耗空间远大于直接存储这三个的数组），当数据稠密时，bitmap存储节省空间。而且还提供了RunContainer利用run-length-encoded算法进行压缩（只有在调用runOptimize()方法才会发生转换，会分别和ArrayContainer、BitmapContainer比较空间占用大小，然后选择是否转换）。</p>
<h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><p>基于用户的行为，对用户的特征进行抽象，使用标签来反映用户的动作与特征。在用户画像中，常常需要根据用户标签去对用户做特定的运营或者活动。</p>
<p>在存储上，考虑到用户标签的不同，如果将所以标签类别作为一张宽表（类似星型模型），将会是个很稀疏的表，且随时面临着标签的增长，所以在存储上选择了Hbase。</p>
<p>而通过某些标签筛选出特定用户是个很常见的需求。而Hbase查询如果不是通过rowkey查询的化，都是scan全表，效率很低。而标签相对于用户数量而言基数较少，且常有根据多个标签组合查询（and或者or），所以想到了将标签使用bitmap索引存储。</p>
<p>所以在标签数据组织上，有个正排的标签表，用户id作为rowkey,主要方便查询用户的标签值。一个标签对应的bitmap索引表，用于通过标签组合过滤查询用户。</p>
<p><img src="https://hexo-1256892004.cos.ap-beijing.myqcloud.com/bitmap/tag-bitmap.png"></p>
<p>将tag表中的用户-标签数据，首先通过hash(uid)做分区，在对同一tag的数据做bitmap index（红色方框）。不同的partition数据分布于hbase的region中。在查询的时候通过协处理器并行查询各个region，最后将数据返回给client。其中进行partition主要是为了：有些标签所覆盖的用户很广，甚至上千万或者上亿，整个bitmap占用的空间会很大，对index构建和查询带来效率问题；划分region后，通过hbase的协处理器可以并发的查询，每个region返回的bitmap也更小，效率更高。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>bitmap提供了不一样的数据存储，以及高效的运算，成为了某些场景下的利刃。比如在标签存储中，可以很好的使用bitmap对标签组合查询用户。但bitmap并非银弹，如果是基数较高或者更新频繁的系统中，似乎并不是很好的方案。但bitmap给予我们提供了一种不同的视角，散列却又聚集。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">weibingo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://wbice.cn/article/bitmap.html">https://wbice.cn/article/bitmap.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/bitmap/">bitmap</a><a class="post-meta__tags" href="/tags/%E6%A0%87%E7%AD%BE/">标签</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=undefined" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/article/olap.html"><i class="fa fa-chevron-left">  </i><span>OLAP引擎思维导图</span></a></div><div class="next-post pull-right"><a href="/article/disk-io.html"><span>磁盘I/O</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = '' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'dEfDWKbVoLq95IOjY2Wucz01-9Nh9j0Va',
  appKey:'CWRYxwiLTYcAG0OcWmKl7Ez0',
  placeholder:'ヾﾉ≧∀≦)o来啊，快活啊，造作啊!',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://hexo-1256892004.cos.ap-beijing.myqcloud.com/page/top.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2024 By weibingo</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.8.0"></script><script src="/js/fancybox.js?version=1.8.0"></script><script src="/js/sidebar.js?version=1.8.0"></script><script src="/js/copy.js?version=1.8.0"></script><script src="/js/fireworks.js?version=1.8.0"></script><script src="/js/transition.js?version=1.8.0"></script><script src="/js/scroll.js?version=1.8.0"></script><script src="/js/head.js?version=1.8.0"></script><script src="/js/search/algolia.js"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>